name: smoke
on: [push, pull_request]
jobs:
  smoke:
    runs-on: ubuntu-latest
    env:
      OVOD_SKIP_SAM2: "1"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.10" }
      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('ci-requirements.txt') }}
          restore-keys: ${{ runner.os }}-pip-
      - run: python -m pip install -U pip
      - run: pip install -r ci-requirements.txt
      - run: pip install git+https://github.com/IDEA-Research/GroundingDINO.git@856dde20aee659246248e20734ef9ba5214f5e44
      - name: quick import checks
        run: |
          cd repo && export PYTHONPATH=$PWD
          python -c "
          try:
              from ovod.pipeline import OVODPipeline
              print('✅ Pipeline import ok')
          except ImportError as e:
              print(f'⚠️ Pipeline import failed (expected in CI): {e}')
          "
      - name: box conversion unit test
        run: |
          cd repo && export PYTHONPATH=$PWD
          python -c "
          from eval import to_coco_xywh
          # Test normalized cxcywh -> pixel xywh
          x,y,w,h = to_coco_xywh([0.5,0.5,0.25,0.5], 640, 480)
          assert w > 0 and h > 0, f'Invalid box conversion: {x},{y},{w},{h}'
          print('✅ Box conversion test passed')
          "
      - name: eval script syntax
        run: |
          cd repo && python -m py_compile eval.py demo_app.py
          echo "✅ Python syntax checks passed"